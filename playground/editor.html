<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/ace.js"></script>

<template name="editor">
	{% with buttonCtx %}
	{% render "button-bar" %}
	{% endwith %}

	<div class="ace-editor" ace-editor={content}></div>
</template>

<script>
Template.editor.helpers({
	buttonCtx: {
		contentView: "editor-navbar"
	}
});

Template.editor.decorate("ace-editor", function(d, content) {
	if (typeof ace === "undefined") return setTimeout(function() {
		d.comp.invalidate();
	}, 500);

	var editor = ace.edit(d.target);
	editor.setTheme("ace/theme/monokai");
    var session = editor.getSession()
	session.setUseWorker(false);
	session.setMode("ace/mode/html");
	session.setUseWrapMode(true);

	Trackr.autorun(function() {
		if (!editor.isFocused()) editor.setValue(content.get(), -1);
	});

	editor.on("change", _.debounce(function() {
		content.set(editor.getValue());
	}, 1000));

	d.comp.onInvalidate(function() {
		editor.destroy();
	});
});
</script>

<template name="editor-navbar" use="actions">
	<div class="dropdown btn" on-click="toggle-dropdown">
		<span class="handle"><i class="icon icon-caret-down"></i></span>
		<span class="value">cli-test.html</span>
		<div class="dropdown-menu">
			<a href="#" on-click={'select-item','cli-test.html'}>cli-test.html</a>
			<a href="#">welcome.html</a>
			<a href="#">list.html</a>
		</div>
	</div>
	<a href="#" class="btn btn-right"><i class="icon icon-share"></i> Share</a>
	<a href="#" class="btn btn-right"><i class="icon icon-reset icon-fw"></i> Start Over</a>
</template>

<script>
function closest(node, selector) {
	while (node) {
		if (node.nodeType === Node.ELEMENT_NODE) {
			if (selector.nodeType === Node.ELEMENT_NODE) {
				if (selector === node) return node;
			} else if (typeof selector === "string") {
				if (node.matches(selector)) return node;
			}
		}

		node = node.parentNode;
	}
}

Template["editor-navbar"].actions("select-item", function(e, item) {
	e.original.preventDefault();
	console.log(item);
});

Template["editor-navbar"].actions("toggle-dropdown", function(e) {
	// don't prevent default on menu item
	if (!closest(e.original.target, ".dropdown-menu a")) {
		e.original.preventDefault();
	}

	var dropdown = e.target;
	dropdown.classList.toggle("open");

	setTimeout(function() {
		var onclick;
		document.addEventListener("click", onclick = function(e) {
			document.removeEventListener("click", onclick);
			if (!closest(e.target, dropdown)) {
				dropdown.classList.remove("open");
			}
		});
	}, 0);
});
</script>

<style>
.ace-editor {
	width: 100%;
	height: 100%;
}
</style>
